<head>


<style> html, body, #map { height: 100%; width: 100%; padding: 0; margin: 0; } </style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
<!--<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />-->

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<!--<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet-src.js"></script>
<script src="./leaflet.ajax.min.js"></script> -->
<script src="https://raruto.github.io/cdn/leaflet-google/0.0.1/leaflet-google.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjaGb-Y6XIZsAkfTFxOg5h4R0wUk9DkBg"></script>

</head>

<body>

  <div id="map"></div>

</body>

<script>
  var map = new L.Map('map', {
    center: [41.4583, 12.7059],
    zoom: 5,
    markerZoomAnimation: true,
    zoomControl: false
  });

  var zoomControl = new L.Control.Zoom({ position: 'topright' });

  var ggl = new L.Google('ROADMAP'); // Possible types: SATELLITE, ROADMAP, HYBRID, TERRAIN

   var url = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
     attr =
     'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
     otm = new L.TileLayer(url, {
       attribution: attr,
       /*subdomains:"1234"*/
     });

  var baseLayers = {
    "Google Map": ggl,
    "Leaflet Map": otm,
  };

  var layersControl = L.control.layers(baseLayers, null, { collapsed:false });

  layersControl.addTo(map);
  zoomControl.addTo(map);

  map.addLayer(ggl);

  map._layersMaxZoom = 19;


var lastData = "";


function setNewData () {
    var fss = $.getJSON('http://127.0.0.1:8000/row/', function(features) {

      console.log('got features' + JSON.stringify(features));
      lastData = features;

      var title = features['obj_id'] + " " + features['obj_name'];
      var marker = L.marker([features['obj_lat'], features['obj_lon']],  { title: title,
       icon: new L.DivIcon({
                  className: 'my-div-icon',
                  html: '<span class="my-div-span" style="color:#FFFFFF; text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;"><strong>'+ features['obj_name'] + '</strong></span>' +
                        '<img class="my-div-image" src="https://unpkg.com/leaflet@1.6.0/dist/images/marker-icon.png"/>' +
                        '<span class="my-div-span" style="color:#FFFFFF; text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;"><strong> OSM </strong></span>'
              })
       }).addTo(map).bindPopup(title);
      console.log('added obj' + title);

      var markers = [marker, ]

      var others = features['others']
      for (var i = 0; i < 5; i++) {
              var a = others[i];
              console.log('got features' + JSON.stringify(a));

              var title_other = a['other_id'] + " " + a['other_name'];
              var marker = L.marker([a['other_lat'], a['other_lon']], { title: title_other,
               icon: new L.DivIcon({
                  className: 'my-div-icon',
                  html: '<span class="my-div-span" style="color:#FFFFFF;text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;"><strong>'+ a['other_name'] + '</strong></span>' +
                        '<img class="my-div-image" src="https://unpkg.com/leaflet@1.6.0/dist/images/marker-icon.png"/>' +
                        '<span class="my-div-span" style="color:#FFFFFF;text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;"><strong>'+ a['num'] + '</strong></span>'
              })

               }).addTo(map).bindPopup(title_other + " " + a['dist']);


               if (a['num'] == 1){
                   markers.push(marker)
			   };

              console.log('added obj' + title_other);
          }

          var group = new L.featureGroup(markers);

          map.fitBounds(group.getBounds());


});

}

const choices = ['1','2','3','4','5','0']

document.body.onkeyup = function(e){
    if(e.key === ' '){
        setNewData();
    }
    if(choices.includes(e.key)){
      console.log('OLOLO' + JSON.stringify(lastData));

      var arrayOfTypeAndId = lastData['obj_id'].split('/');
      var other = "";
      for (var i = 0; i < 5; i++) {
          var other = lastData['others'][i];
          var mark = 0;
          if (other['num'].toString() == e.key){
              var mark = 1;
          };

        var sendingData = JSON.stringify({
          "obj_id": arrayOfTypeAndId[1],
          "obj_type": arrayOfTypeAndId[0],
          "obj_lat": lastData['obj_lat'],
          "obj_lon": lastData['obj_lon'],
          "obj_meta": lastData['obj_name'],
          "other_id": other['other_id'],
          "mark": mark,
          "other_lat": other['other_lat'],
          "other_lon": other['other_lon'],
          "other_meta": other['other_name']
         });
         $.post("/mark/", sendingData);

       };


      alert("SENT");
    }
}
</script>